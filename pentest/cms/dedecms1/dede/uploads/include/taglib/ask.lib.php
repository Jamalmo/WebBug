<?php if(!defined('DEDEINC')) exit('Request Error!');
/**
 * 问答调用标签
 *
 * @version        $Id: ask.lib.php 1 9:29 2010年7月6日Z tianya $
 * @package        DedeCMS.Taglib
 * @copyright      Copyright (c) 2007 - 2010, DesDev, Inc.
 * @license        http://help.dedecms.com/usersguide/license.html
 * @link           http://www.dedecms.com
 */
 
 /*>>dede>>
<name>问答标签</name>
<type>全局标记</type>
<for>V55,V56,V57</for>
<description>问答调用标签</description>
<demo>
{dede:ask row='6' qtype='new' tid='0' titlelen='24'}
<dd>
    <span class="tclass">[<a href='[field:typeurl/]'>[field:tidname/]</a>]</span>
    <span class="tlink"><a href="[field:url/]">[field:title/]</a></span>
</dd>
{/dede:ask}
</demo>
<attributes>
    <iterm>row:调用条数</iterm> 
    <iterm>qtype:排序类型 commend 推荐、ok 表示已解决问题、high 高分问题 、new 最新问题</iterm>
    <iterm>tid:栏目id，默认是全部</iterm>
    <iterm>titlelen:标题长度</iterm>
</attributes> 
>>dede>>*/
function lib_ask(&$ctag,&$refObj)
{
    global $dsql, $envs, $cfg_dbprefix, $cfg_cmsurl;
    //属性处理
    $attlist="row|6,qtype|new,tid|0,titlelen|24";
    FillAttsDefault($ctag->CAttribute->Items,$attlist);
    extract($ctag->CAttribute->Items, EXTR_SKIP);
    
    if( !$dsql->IsTable("{$cfg_dbprefix}ask") ) return '没安装圈子模块';

    if(!preg_match("#\/$#", $cfg_cmsurl)) $cfg_ask_url = $cfg_cmsurl."/ask";
    else $cfg_ask_url = $cfg_cmsurl."ask";
    
    $innertext = $ctag->GetInnerText();
    if(trim($innertext)=='') $innertext = GetSysTemplets("asks.htm");
    
    $qtypeQuery = '';
    if($tid>0) $tid = " (tid=$tid Or tid2='$tid') AND ";
    else $tid = '';
    //推荐问题
    if($qtype=='commend') $qtypeQuery = " $tid digest=1 ORDER BY dateline DESC ";
    //新解决问题
    else if($qtype=='ok') $qtypeQuery = " $tid status=1 ORDER BY solvetime DESC ";
    //高分问题
    else if($qtype=='high') $qtypeQuery = " $tid status=0 ORDER BY reward DESC ";
    //新问题
    else $qtypeQuery = " $tid status=0 ORDER BY disorder DESC, dateline DESC ";

    $ctp = new DedeTagParse();
    $ctp->SetNameSpace('field', '[', ']');

    $solvingask = '';
    $query = "SELECT id, tid, tidname, tid2, tid2name, title FROM `#@__ask` WHERE $qtypeQuery  limit 0, $row";
    $dsql->Execute('me',$query);
    while($rs = $dsql->GetArray('me'))
    {
        $rs['title'] = cn_substr($rs['title'], $titlelen);
        $ctp->LoadSource($innertext);
        if($rs['tid2name'] != '')
        {
            $rs['tid'] = $rs['tid2'];
            $rs['tidname'] = $rs['tid2name'];
        }
        $rs['url'] = $cfg_ask_url."/question.php?id={$rs['id']}";
        $rs['typeurl'] = $cfg_ask_url."/browser.php?tid={$rs['tid']}";
        foreach($ctp->CTags as $tagid=>$ctag) {
            if(!empty($rs[strtolower($ctag->GetName())])) {
                $ctp->Assign($tagid,$rs[$ctag->GetName()]);
            }
        }
        $solvingask .= $ctp->GetResult();
    }
    return $solvingask;
}