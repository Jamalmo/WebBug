<?php
/**
 *      后台支付设置控制器
 *      [Haidao] (C)2013-2099 Dmibox Science and technology co., LTD.
 *      This is NOT a freeware, use is subject to license terms
 *
 *      http://www.haidao.la
 *      tel:400-600-2042
 */
core::load_class('init', 'admin');
class admin_control extends init_control {

    public function _initialize() {
        parent::_initialize();
        $this->service = model('payment', 'service');
        $this->payments = $this->service->fetch_all();
    }

    /**
     * 获取支付方式列表
     */
    public function setting() {
        $payments = $this->payments;
        include $this->admin_tpl('setting');
    }

    /**
     * 配置支付方式
     */
    public function config() {

        $pay_code = $_GET['pay_code'];
        $payment = $this->payments[$pay_code];
        if (checksubmit('dosubmit')) {
            $_POST['config'] = serialize($_POST['config']);
            if ($this->service->save($_POST)) {
            	$this->service->build_cache();
                showmessage('设置支付方式成功', url('setting'), 1);
            } else {
                showmessage('设置支付方式失败', url('setting'), 0);
            }
        } else {
            include $this->admin_tpl('config');
        }
    }

    /**
     * 启用禁用支付方式
     */
    public function ajax_enabled() {
        $paycode = $_POST['paycode'];
        if ($this->service->change_enabled($paycode)) {
            showmessage('设置支付方式成功', '', 1);
        } else {
            showmessage('设置支付方式失败', '', 0);
        }
    }

    /**
     * 卸载支付方式
     */
    public function uninstall() {
        $pay_code = $_GET['pay_code'];
        $data = array();
        $data['pay_code'] = $pay_code;
        model('payment')->where(array('pay_code'=>$pay_code))->delete();
		$this->service->build_cache();
        showmessage('卸载支付方式成功', url('setting'), 1);

    }

}
