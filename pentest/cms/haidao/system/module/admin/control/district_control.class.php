<?php
/**
 *      [Haidao] (C)2013-2099 Dmibox Science and technology co., LTD.
 *      This is NOT a freeware, use is subject to license terms
 *
 *      http://www.haidao.la
 *      tel:400-600-2042
 */
class district_control extends init_control {
	public function _initialize() {
		parent::_initialize();
		$this->service = model('admin/district', 'service');
		$this->model = model('admin/district');
	}

	/* 地区管理 */
	public function index() {
		$districts = $this->service->get_children();
		include $this->admin_tpl('district_index');
	}

	/* 添加地区 */
	public function add() {
		$parent_id = (int)$_GET['parent_id'];
		$parent_pos = array('顶级地区');
		if ($parent_id > 0) {
			$parent_pos = $this->service->fetch_position($parent_id);
		}
		if (checksubmit('dosubmit')) {
			if (FALSE === $this->service->update($_GET)) {
				showmessage($this->service->error);
			}
			showmessage('地址添加成功', url('index'), 1);
		} else {
			include $this->admin_tpl('district_add');
		}
	}

	public function edit() {
		$id = $_GET['id'];
		if ($id < 1) {
			showmessage('参数错误');
		}
		$r = $this->service->fetch_by_id($id);
		$parent_pos = array('顶级地区');
		if ($r['parent_id'] > 0) {
			$parent_pos = $this->service->fetch_position($r['id']);
		}
		if (checksubmit('dosubmit')) {
			$params = array_merge($r, $_GET);
			if (FALSE === $this->service->update($params)) {
				showmessage($this->service->error);
			}
			showmessage('地址编辑成功', url('index'), 1);
		} else {
			include $this->admin_tpl('district_edit');
		}
	}

	public function delete() {
		$ids = (array)$_GET['ids'];
		$result = $this->service->delete($ids);
		if ($result === false) {
			showmessage($this->service->error);
		}
		showmessage('指定地区删除成功');
	}

	/* 更新排序 */
	public function ajax_sort() {
		$id = (int)$_GET['id'];
		$sort = (int)$_GET['sort'];
		$result = $this->model->where(array('id' => $id))->setField('sort', $sort);
		if ($result === FALSE) {
			showmessage($this->model->getError());
		} else {
			showmessage('排序修改成功', url('index'), 1);
		}
	}

	/* 更新地区名称 */
	public function ajax_name() {
		$params = array();
		$params['id'] = (int)$_GET['id'];
		$params['name'] = trim($_GET['name']);
		if (empty($params['name'])) {
			showmessage('地区名称不能为空');
		}
		$pinyin = pinyin($params['name']);
		$params['pinyin'] = implode($pinyin, '');
		$result = $this->model->update($params);
		if ($result === FALSE) {
			showmessage($this->model->getError());
		} else {
			showmessage('地区名称修改成功', url('index'), 1);
		}
	}

	public function ajax_district() {
		$id = (int)$_GET['id'];
		$result = (array)$this->service->get_children($id);
		if ($result) {
			foreach ($result as $key => $value) {
				$value['_child'] = $this->model->where(array('parent_id' => $value['id']))->count();
				$result[$key] = $value;
			}
		}
		echo json_encode($result);
	}

}
